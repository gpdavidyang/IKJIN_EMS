# IKJIN Expense Management System – Product Requirements Document

## 1. 배경 및 문제 정의
- **회사**: 익진엔지니어링(이하 익진, IKJIN). 건설 현장과 본사 간 발주서 관리를 이미 Supabase 기반 웹 시스템으로 운영 중.
- **현 상황**: 경비 정산·품의가 종이/엑셀로 진행되며 오류, 결재 지연, 현장별 가시성 부족이 발생.
- **기회**: 경비 처리를 디지털화하여 승인 리드타임과 업무 부담을 줄이고, 향후 발주시스템/프로젝트 관리 시스템과 데이터 레이어를 통합할 기반 마련.

## 2. 제품 목표
1. 전 직원의 경비 입력 및 추적을 웹에서 일원화하여 **업무 효율 30% 이상 개선**.
2. **3단계 전자 결재**(현장 소장 → 본사 관리자)를 적용하며, 반려 사유 공유와 재제출 프로세스를 제공.
3. **연동 대비**: Supabase 기반 사용자/현장 데이터를 공통 소스에 저장하거나 싱크할 수 있도록 API 및 데이터 모델을 설계.

## 3. 주요 성공 지표 (KPIs)
- 평균 결재 완료 리드타임 3일 → 1일 이하 단축.
- 반려 후 재제출 평균 횟수 1.8회 → 1.2회 이하.
- 경비 입력 누락률 10% → 2% 이하.
- 월간 보고서 작성시간 4시간 → 30분 이하.

## 4. 사용자 및 페르소나
- **현장 직원 (Submitter)**: 현장별 경비를 입력/임시저장/제출/재제출.
- **현장 소장 (Site Manager)**: 소속 현장 경비 검토, 일괄 승인·반려, 현장 리포트 조회.
- **본사 관리자 (HQ Admin)**: 전체 현장 경비 승인, 보고서 추출, 사용자·현장 등록.
- **재무팀/감사 (Auditor - 읽기 전용)**: 감사 목적의 조회/다운로드.

## 5. 범위 (Scope)
### 5.1 필수 기능
1. **인증·권한 관리**
   - Supabase Auth 연계를 고려한 JWT 기반 인증 (MVP에서는 독립 앱 DB, 이후 통합 시 마이그레이션 지원).
   - 역할: Submitter, SiteManager, HQAdmin, Auditor(읽기 전용).
   - 현장별 접근 제어: SiteManager는 본인 현장만, Submitter는 자신의 제출 내역만 조작 가능.
2. **경비 입력**
   - 필수 필드: 경비 항목(드롭다운), 금액, 사용일자, 사용처, 현장명(드롭다운), 용도 상세.
   - 임시 저장/자동 저장(초안) 및 이후 수정.
3. **전자 결재 워크플로우**
   - 상태: `임시저장` → `소장승인대기` → `본사승인대기` → `승인완료` / `소장반려` / `본사반려`.
   - 반려 사유 필수 입력, 제출자 피드백 표시.
   - 일괄 승인/반려 (SiteManager, HQAdmin).
   - 반려 건 재제출.
4. **조회/필터 및 리포트**
   - 기간/현장/상태/항목/금액 범위 필터.
   - 서버사이드 페이지네이션.
   - 엑셀(XLSX) 다운로드.
5. **감사 및 기록**
   - 모든 상태 변경/댓글 로그 (audit trail).
   - 변경 이력 조회 UI (최소 MVP는 관리자 전용 화면).

### 5.2 향후 확장 고려
- 영수증 이미지 첨부 (Object Storage, 예: Supabase Storage 혹은 AWS S3).
- 발주시스템과의 연계: 공통 사용자·현장 테이블, 경비와 발주 데이터 상호 참조.
- 프로젝트 진행관리 시스템과의 연동: 현장/프로젝트 코드 매핑, 공통 대시보드.
- 자동화: 승인 알림 Slack/Teams, 회계 시스템 전송.

### 5.3 범위 외 (Out of Scope)
- 모바일 앱 (웹 반응형만 지원).
- 자동 회계 분개 처리.
- 복잡한 세금 계산/환율 기능.

## 6. 사용자 여정 (User Journey)
1. **Submitter**: 로그인 → 현장 선택 → 경비 입력 → 임시저장/제출 → 반려 알림 → 수정 후 재제출.
2. **SiteManager**: 로그인 → 대기 리스트 → 단일/일괄 승인/반려 → 반려 코멘트 → 승인 시 본사 큐 이동.
3. **HQAdmin**: 대기 리스트 → 검토 → 승인 또는 반려 → 최종 승인 후 보고서 생성.
4. **Auditor**: 기간별 보고서 조회 → 필터링 → 다운로드.

## 7. 상세 요구사항
### 7.1 기능 요구사항
- `FR-01` 로그인 및 역할 기반 대시보드 표시.
- `FR-02` 경비 임시 저장, 목록 조회, 재편집.
- `FR-03` 제출 시 소속 현장 자동 매핑.
- `FR-04` 승인 대기 내역 필터 및 정렬.
- `FR-05` 일괄 승인/반려 시 선택 항목 제한(최대 20건) 및 처리 결과 피드백.
- `FR-06` 반려 사유 200자 이내 필수 입력.
- `FR-07` 재제출 시 이전 버전 백업 및 버전 넘버 증가.
- `FR-08` 승인/반려 시 이메일 알림 (MVP: 제출자 및 다음 결재자).
- `FR-09` 감사 로그/이력 조회 API.
- `FR-10` 보고서 다운로드: UTF-8 CSV + XLSX 제공.

### 7.2 비기능 요구사항
- **성능**: 주요 API 응답 200ms 이하(평균), 보고서 생성 10초 이내.
- **가용성**: 99.5% 이상 (월간 다운타임 3.6시간 이하).
- **보안**: OWASP Top10 대비, 모든 민감 데이터 HTTPS 전송, 비밀번호 Argon2id 해시.
- **확장성**: 30 사용자 동시 접속, 향후 100명까지 수평 확장 가능.
- **데이터 관리**: PostgreSQL + Supabase 연동 대비 DB 스키마 버전 관리, 마이그레이션 스크립트.
- **감사 추적**: 모든 상태 전환/댓글/다운로드 기록 저장 (7년 보관).

## 8. 데이터 상호 운용성
- **사용자 & 현장**: 발주시스템(Supabase)에서 사용 중인 테이블과 스키마를 분석하여 공통 `sites`, `users` 테이블을 설계. 향후에는 Supabase DB와 동일 스키마 유지 또는 CDC(변경 데이터 캡쳐) 동기화 고려.
- **식별자 정책**: UUID 기반 ID 사용으로 시스템 간 충돌 방지.
- **API 게이트웨이**: 향후 통합을 위해 GraphQL/Federation 또는 REST API Gateway를 도입할 수 있도록 문서화.
- **Single Sign-On**: Supabase Auth 토큰을 공유하는 전략을 검토 (MVP는 독립 로그인, phase 2에서 토큰 교환 or OAuth).

## 9. 가정 및 제약
- 초기 MVP는 독립 배포(Separate DB)하되, 스키마/ERD는 Supabase와 호환되도록 설계.
- 운영 예산 제한: Managed DB(Pg), Object Storage 비용 최소화.
- 네트워크 접근: 내부망 + VPN 환경에서 접속.
- 사내 정책상 이메일 알림은 사내 SMTP 사용.

## 10. 리스크 및 대응
| 리스크 | 영향 | 완화 전략 |
| --- | --- | --- |
| 기존 Supabase 데이터와의 스키마 차이 | 향후 통합 시 재작업 | 초기부터 공통 컬럼 정의 및 naming convention 일치 |
| 승인 지연 지속 | 사용자 만족도 하락 | 알림 강화, 대시보드 KPI 노출 |
| 권한 오남용 | 데이터 노출 | 현장별 RBAC + 감사 로그 정기 검토 |
| 파일 첨부 기능 확장 시 비용/성능 | 운영 부담 | 오브젝트 스토리지 사용량 모니터링, 업로드 제한 |

## 11. 론칭 전략
1. **내부 베타 (2주)**: HQAdmin/일부 SiteManager로 제한.
2. **현장별 단계적 롤아웃 (4주)**: 피드백 반영, 교육 자료 공유.
3. **정식 론칭**: 전 현장 확대, 발주시스템 연동 기획 시작.

## 12. 문서 및 전달물
- ERD, API 명세(OpenAPI), 권한 매트릭스.
- 사용자 매뉴얼, 승인 프로세스 가이드, FAQ.
- 유지보수 Runbook (운영팀용).
